<html>
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Top Rug | NFT Flight Game</title>
		<meta name="description" content="Fly through the skies with your NFT banner! Top Rug - collect coins, avoid obstacles, and showcase your NFTs." />
		<meta name="keywords" content="three.js, webgl, tutorial, game, 3d, animation, airplane, web development, javascript" />
		<meta name="author" content="Karim Maaloul for Codrops" />
		<link rel="shortcut icon" href="shared/assets/icons/favicon.ico">
		<link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700,700italic' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="shared/css/ui.css" />
		<script type="text/javascript" src="shared/js/TweenMax.min.js"></script>
		<script type="text/javascript" src="shared/js/three.min.js"></script>
		<!-- Unified game controller and core systems -->
		<script type="text/javascript" src="GameController.js"></script>
		<script type="text/javascript" src="core/audio/AudioManager.js"></script>
		<script type="text/javascript" src="core/engine/GameEngine.js?v=20241220"></script>
		<script type="text/javascript" src="core/ui/UIManager.js?v=20241220"></script>
		<script type="text/javascript" src="core/ui/VisualDesignSystem.js?v=20241220"></script>
		<script type="text/javascript" src="core/assets/TextureManager.js?v=20241220"></script>
		<script type="text/javascript" src="core/StorageManager.js"></script>
		<script type="text/javascript" src="core/ModeController.js"></script>
		<script type="text/javascript" src="core/ObjectPool.js"></script>
		<script type="text/javascript" src="core/PerformanceMonitor.js"></script>
		<script type="text/javascript" src="tests/GameTestSuite.js"></script>
		<!-- Game modes -->
		<script type="text/javascript" src="modes/classic/ClassicGame.js?v=20241220"></script>
		<script type="text/javascript" src="modes/classic/ClassicHUD.js?v=20241220"></script>
		<script type="text/javascript" src="modes/classic/BannerSystem.js?v=20241220"></script>
		<script type="text/javascript" src="modes/combat/CombatGame.js?v=20241220"></script>
		<script type="text/javascript" src="modes/combat/CombatHUD.js?v=20241220"></script>
		<script type="text/javascript" src="modes/combat/CombatSceneManager.js?v=20241220"></script>
		<script type="text/javascript" src="modes/combat/CombatAirplane.js?v=20241220"></script>
		<script type="text/javascript" src="modes/combat/CombatPilot.js"></script>
		<script type="text/javascript" src="modes/combat/CombatSea.js"></script>
		<script type="text/javascript" src="modes/combat/CombatSky.js"></script>
		<script type="text/javascript" src="modes/combat/CombatCloud.js"></script>
		<script type="text/javascript" src="modes/combat/CombatCoin.js"></script>
		<script type="text/javascript" src="modes/combat/CombatEnemy.js"></script>
		<script type="text/javascript" src="modes/combat/CombatProjectile.js"></script>
		<script type="text/javascript" src="modes/combat/WeaponSystem.js"></script>
		<script type="text/javascript" src="modes/combat/EnemySystem.js"></script>
		<!--[if IE]>
		  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	</head>
	<body>
		<!-- Game Mode Selector -->
		<div class="game-mode-selector" id="gameModeSelector">
			<div class="mode-selector-content">
				<h1><span>Top</span>Rug</h1>
				<h2>Select Game Mode</h2>
				<div class="mode-buttons">
					<button class="mode-button" data-mode="classic">
						<div class="mode-title">Top Rug Classic</div>
						<div class="mode-description">Classic flight game with NFT banner support</div>
					</button>
					<button class="mode-button" data-mode="combat">
						<div class="mode-title">Top Rug Combat</div>
						<div class="mode-description">Enhanced version with weapons and enemies</div>
					</button>
				</div>
			</div>
		</div>

		<!-- Unified Game Container -->
		<div class="game-holder unified-game" id="gameHolder" style="display: none;">
			<!-- Game canvas will be inserted here by GameEngine -->
		</div>

		<!-- Top Rug Game Container -->
		<div class="game-holder game-holder--toprug1" id="gameHolderTopRug1" style="display: none;">
			<div class="header">
				<h1><span>Top</span>Rug</h1>
				<h2>Classic Edition</h2>
				<div class="score" id="score-toprug1">
					<div class="score__content" id="level-toprug1">
						<div class="score__label">level</div>
						<div class="score__value score__value--level" id="levelValue-toprug1" data-mode-ui="classic">1</div>
						<svg class="level-circle" id="levelCircle-toprug1" data-mode-ui="classic" viewbox="0 0 200 200">
							<circle id="levelCircleBgr-toprug1" r="80" cx="100" cy="100" fill="none" stroke="#d1b790" stroke-width="24px" />
							<circle id="levelCircleStroke-toprug1" r="80" cx="100" cy="100" fill="none" #f25346 stroke="#68c3c0" stroke-width="14px" stroke-dasharray="502" />
						</svg>
					</div>
					<div class="score__content" id="dist-toprug1">
						<div class="score__label">distance</div>
						<div class="score__value score__value--dist" id="distValue-toprug1" data-mode-ui="classic">000</div>
					</div>
					<div class="score__content" id="energy-toprug1">
						<div class="score__label">energy</div>
						<div class="score__value score__value--energy" id="energyValue-toprug1">
							<div class="energy-bar" id="energyBar-toprug1" data-mode-ui="classic"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="world" id="world-toprug1"></div>
			<div class="message message--replay" id="replayMessage-toprug1" data-mode-ui="classic">Click to Replay</div>
			<div class="message message--instructions" id="instructions-toprug1" data-mode-ui="classic">Grab the blue pills<span>avoid the red ones</span></div>
		</div>

		<!-- Top Rug: Maverick Game Container -->
		<div class="game-holder game-holder--toprug2" id="gameHolderTopRug2" style="display: none;">
			<div class="header">
				<div class="header__title-wrap">
					<h1 class="header__title">
						<span class="header__title-pre">Top Rug:</span>
						<span class="header__title-main">Maverick</span>
					</h1>
					<h2 class="header__tagline">Enhanced flight combat with weapons and enemies</h2>
				</div>
				<div class="score" id="score-toprug2">
					<div class="score__content" id="level-toprug2">
						<div class="score__label">level</div>
						<div class="score__value score__value--level" id="levelValue-toprug2">1</div>
						<svg class="level-circle" id="levelCircle-toprug2" viewbox="0 0 200 200">
							<circle id="levelCircleBgr-toprug2" r="80" cx="100" cy="100" fill="none" stroke="#d1b790" stroke-width="24px" />
							<circle id="levelCircleStroke-toprug2" r="80" cx="100" cy="100" fill="none" #f25346 stroke="#68c3c0" stroke-width="14px" stroke-dasharray="502" />
						</svg>
					</div>
					<div class="score__content score__content--fixed" id="dist-toprug2">
						<div class="score__label">distance</div>
						<div class="score__value score__value--dist" id="distValue-toprug2">0</div>
					</div>
					<div class="score__content score__content--fixed" id="coins-toprug2">
						<div class="score__label">coins</div>
						<div class="score__value score__value--dist" id="coinsValue-toprug2">0</div>
					</div>
					<div class="score__content score__content--fixed" id="lifes-toprug2">
						<div class="score__label">life</div>
						<div class="score__value score__value--lifes">
							<img class="heart" src="modes/combat/assets/images/heart.png"/>
							<img class="heart" src="modes/combat/assets/images/heart.png"/>
							<img class="heart" src="modes/combat/assets/images/heart.png"/>
						</div>
					</div>
				</div>
			</div>
			<div class="world" id="world-toprug2">
				<canvas id="threejs-canvas"></canvas>
			</div>
			<div class="message--replay" id="replayMessage-toprug2">
				Click to Replay
			</div>
			<div id="error">
				<p><b>Error</b></p>
				<p id="error-message"></p>
			</div>
			<div id="new-level">
				<p>Level</p>
				<p>1</p>
			</div>
			<div id="intro-screen" class="visible">
				<button type="button">Start</button>
			</div>
			<div id="score-screen">
				<div>
					<p class="headline">Map complete</p>
					<div class="lines">
						<div>
							<span>Coins</span>
							<span><span id="score-coins-collected">129</span> / <span id="score-coins-total">136</span></span>
						</div>
						<div>
							<span>Enemies killed</span>
							<span><span id="score-enemies-killed">3</span> / <span id="score-enemies-total">20</span></span>
						</div>
						<div>
							<span>Shots fired</span>
							<span><span id="score-shots-fired">9820</span></span>
						</div>
						<div>
							<span>Damage taken</span>
							<span><span id="score-lifes-lost">1</span></span>
						</div>
					</div>
				</div>
				<br/>
				Thanks for playing!
			</div>

			<!-- Combat HUD -->
			<div class="combat-hud" id="combat-hud" data-mode-ui="combat" style="display: none;">
				<div class="combat-lives" id="combat-lives" data-mode-ui="combat"></div>
				<div class="combat-stats" data-mode-ui="combat">
					<div class="combat-score" id="combat-score" data-mode-ui="combat">0</div>
					<div class="combat-weapon" id="combat-weapon" data-mode-ui="combat">SIMPLE</div>
					<div class="combat-ammo" id="combat-ammo" data-mode-ui="combat">100</div>
					<div class="combat-level" id="combat-level" data-mode-ui="combat">1</div>
				</div>
			</div>


			<!-- Test Panel (hidden by default, activated by pressing T key) -->
			<div class="test-panel" id="testPanel" style="display: none;">
				<div class="test-header">
					<h3>üß™ Game Test Suite</h3>
					<button class="test-close" id="closeTestPanel">√ó</button>
				</div>
				<div class="test-controls">
					<button class="test-button" id="runAllTests">Run All Tests</button>
					<button class="test-button" id="runPerformanceTests">Performance Tests</button>
					<button class="test-button" id="runStorageTests">Storage Tests</button>
				</div>
				<div class="test-results" id="testResults">
					<div class="test-status">Ready to run tests. Press "Run All Tests" to begin.</div>
				</div>
			</div>
		</div>

		<!-- Mode Switcher UI (moved outside containers for global access) -->
		<div class="mode-switcher" id="modeSwitcher" style="display: none;">
			<button class="mode-switch-button" data-switch-mode="classic" id="switchToClassic">
				üéñÔ∏è Classic Mode
			</button>
			<button class="mode-switch-button" data-switch-mode="combat" id="switchToCombat">
				‚öîÔ∏è Combat Mode
			</button>
			<button class="mode-switch-close" id="closeModeSwitcher">√ó</button>
		</div>

		<!-- Mode Switch Toggle Button (moved outside containers for global access) -->
		<button class="mode-switch-toggle" id="modeSwitchToggle" style="display: none;">
			üîÑ Switch Mode
		</button>

		<!-- Game Controller Initialization -->
		<script>
		// Initialize game when DOM is ready
		document.addEventListener('DOMContentLoaded', async function() {
			console.log('Initializing unified Top Rug game...');

			try {
				// Initialize visual design system
				const vds = getVisualDesignSystem();
				vds.applyStyles();

				// Get mode selector buttons
				const modeButtons = document.querySelectorAll('.mode-button');

				// Set up mode selection handlers
				modeButtons.forEach(button => {
					button.addEventListener('click', async function() {
						const mode = this.getAttribute('data-mode');
						if (this.disabled) {
							console.log(`Mode ${mode} is not yet available`);
							return;
						}

						console.log(`Starting game in ${mode} mode...`);
						try {
							await initGame(mode);

							// Set visual design system mode
							const vds = getVisualDesignSystem();
							vds.setMode(mode);
						} catch (error) {
							console.error('Failed to start game:', error);
							alert('Failed to start game. Check console for details.');
						}
					});
				});

				// Set up in-game mode switcher
				setupModeSwitcher();

				console.log('Game initialization complete. Click a mode to start!');

			} catch (error) {
				console.error('Game initialization failed:', error);
				alert('Game initialization failed. Check console for details.');
			}
		});

		// Set up test panel
		function setupTestPanel() {
			const testPanel = document.getElementById('testPanel');
			const closeButton = document.getElementById('closeTestPanel');
			const runAllTestsButton = document.getElementById('runAllTests');
			const runPerformanceTestsButton = document.getElementById('runPerformanceTests');
			const runStorageTestsButton = document.getElementById('runStorageTests');
			const testResults = document.getElementById('testResults');

			// Close test panel
			closeButton.addEventListener('click', function() {
				testPanel.style.display = 'none';
			});

			// Run all tests
			runAllTestsButton.addEventListener('click', async function() {
				try {
					testResults.innerHTML = '<div class="test-status">Running tests...</div>';
					runAllTestsButton.disabled = true;
					runAllTestsButton.textContent = 'Running...';

					const testSuite = getGameTestSuite();
					await testSuite.runAllTests();

					const results = testSuite.getResults();
					displayTestResults(results);

				} catch (error) {
					console.error('Test suite failed:', error);
					testResults.innerHTML = '<div class="test-status" style="color: #f25346;">Test suite failed: ' + error.message + '</div>';
				} finally {
					runAllTestsButton.disabled = false;
					runAllTestsButton.textContent = 'Run All Tests';
				}
			});

			// Run performance tests only
			runPerformanceTestsButton.addEventListener('click', async function() {
				try {
					testResults.innerHTML = '<div class="test-status">Running performance tests...</div>';
					runPerformanceTestsButton.disabled = true;
					runPerformanceTestsButton.textContent = 'Running...';

					const monitor = getPerformanceMonitor();
					const results = {
						total: 1,
						passed: 1,
						failed: 0,
						results: [{
							name: 'Performance Test',
							status: 'passed',
							result: `FPS: ${monitor.getStats().averageFPS}, Memory: ${monitor.getStats().memoryUsageMB}MB`
						}]
					};

					displayTestResults(results);

				} catch (error) {
					console.error('Performance test failed:', error);
					testResults.innerHTML = '<div class="test-status" style="color: #f25346;">Performance test failed: ' + error.message + '</div>';
				} finally {
					runPerformanceTestsButton.disabled = false;
					runPerformanceTestsButton.textContent = 'Performance Tests';
				}
			});

			// Run storage tests only
			runStorageTestsButton.addEventListener('click', async function() {
				try {
					testResults.innerHTML = '<div class="test-status">Running storage tests...</div>';
					runStorageTestsButton.disabled = true;
					runStorageTestsButton.textContent = 'Running...';

					const storage = getStorageManager();
					const info = storage.getStorageInfo();

					const results = {
						total: 1,
						passed: 1,
						failed: 0,
						results: [{
							name: 'Storage Test',
							status: 'passed',
							result: `Storage available: ${info.available}, Items: ${info.items}, Size: ${info.usedKB}KB`
						}]
					};

					displayTestResults(results);

				} catch (error) {
					console.error('Storage test failed:', error);
					testResults.innerHTML = '<div class="test-status" style="color: #f25346;">Storage test failed: ' + error.message + '</div>';
				} finally {
					runStorageTestsButton.disabled = false;
					runStorageTestsButton.textContent = 'Storage Tests';
				}
			});

			// Display test results
			function displayTestResults(results) {
				let html = '<div class="test-summary">';
				html += `<h4>Test Results: ${results.passed}/${results.total} passed</h4>`;

				results.results.forEach(result => {
					html += `<div class="test-item ${result.status}">`;
					html += `<strong>${result.status === 'passed' ? '‚úÖ' : '‚ùå'} ${result.name}</strong>`;
					if (result.result) {
						html += `<br><small>${result.result}</small>`;
					}
					if (result.error) {
						html += `<br><small style="color: #f25346;">${result.error}</small>`;
					}
					html += '</div>';
				});

				html += '</div>';
				testResults.innerHTML = html;
			}

			console.log('Test panel initialized');
		}

		// Toggle test panel visibility
		function toggleTestPanel() {
			const testPanel = document.getElementById('testPanel');
			const isVisible = testPanel.style.display !== 'none';
			testPanel.style.display = isVisible ? 'none' : 'block';
		}

		// Set up in-game mode switching UI
		function setupModeSwitcher() {
			const modeSwitcher = document.getElementById('modeSwitcher');
			const modeSwitchToggle = document.getElementById('modeSwitchToggle');
			const closeButton = document.getElementById('closeModeSwitcher');
			const switchButtons = document.querySelectorAll('.mode-switch-button');

			// Check if all required elements exist
			if (!modeSwitcher || !modeSwitchToggle || !closeButton) {
				console.warn('Mode switcher elements not found, skipping setup:', {
					modeSwitcher: !!modeSwitcher,
					modeSwitchToggle: !!modeSwitchToggle,
					closeButton: !!closeButton
				});
				return; // Skip setup instead of throwing error
			}

			// Toggle mode switcher visibility
			modeSwitchToggle.addEventListener('click', function() {
				const isVisible = modeSwitcher.style.display !== 'none';
				modeSwitcher.style.display = isVisible ? 'none' : 'flex';
			});

			// Close mode switcher
			closeButton.addEventListener('click', function() {
				modeSwitcher.style.display = 'none';
			});

			// Handle mode switching
			switchButtons.forEach(button => {
				button.addEventListener('click', async function() {
					const targetMode = this.getAttribute('data-switch-mode');

					// Close the switcher
					modeSwitcher.style.display = 'none';

					// Switch mode
					try {
						const controller = window.getGameController && window.getGameController();
						if (controller && controller.modeController) {
							const success = await controller.modeController.switchMode(targetMode);
							if (success) {
								console.log(`Switched to ${targetMode} mode`);
								updateModeSwitcherButtons(targetMode);
							}
						}
					} catch (error) {
						console.error('Failed to switch mode:', error);
						alert('Failed to switch mode. Check console for details.');
					}
				});
			});

			// Update button states based on current mode
			function updateModeSwitcherButtons(currentMode) {
				switchButtons.forEach(button => {
					const buttonMode = button.getAttribute('data-switch-mode');
					button.classList.toggle('active', buttonMode === currentMode);
				});
			}

			// Listen for mode switch events
			window.addEventListener('modeSwitched', function(event) {
				updateModeSwitcherButtons(event.detail.newMode);
			});

			// Hide mode switcher when clicking outside
			document.addEventListener('click', function(event) {
				if (!modeSwitcher.contains(event.target) &&
					!modeSwitchToggle.contains(event.target) &&
					modeSwitcher.style.display !== 'none') {
					modeSwitcher.style.display = 'none';
				}
			});

			// Add keyboard shortcuts
			document.addEventListener('keydown', function(event) {
				// Tab key for mode switcher
				if (event.key === 'Tab') {
					event.preventDefault();
					modeSwitchToggle.click();
				}

				// T key for test panel
				if (event.key === 't' || event.key === 'T') {
					event.preventDefault();
					toggleTestPanel();
				}
			});

			// Set up test panel
			setupTestPanel();

			console.log('Mode switcher UI initialized');
		}
		</script>
	</body>
</html>
